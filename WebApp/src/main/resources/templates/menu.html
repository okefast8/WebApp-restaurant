<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .star {
            cursor: pointer;
            font-size: 1.3rem;
            color: #ccc;
        }

        .star.selected {
            color: gold;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">

    <!-- ===== HEADER ===== -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>–ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>

        <div class="d-flex align-items-center gap-2">
            <span class="fw-bold">
                –ë–∞–ª–∞–Ω—Å:
                <span data-balance th:text="${currentUser.balance}"></span> ‚ÇΩ
            </span>

            <button class="btn btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#profileModal">
                –ü—Ä–æ—Ñ–∏–ª—å
            </button>

            <a th:href="@{/cart}" class="btn btn-outline-primary">–ö–æ—Ä–∑–∏–Ω–∞</a>
            <a th:href="@{/logout}" class="btn btn-outline-danger">–í—ã–π—Ç–∏</a>
        </div>
    </div>

    <!-- ===== –ö–ê–¢–ï–ì–û–†–ò–ò ===== -->
    <div class="mb-4 text-center">
        <div class="btn-group" role="group">

            <button class="btn btn-dark active"
                    onclick="filterCategory('ALL', this)">
                –í—Å–µ
            </button>

            <button class="btn btn-outline-dark"
                    onclick="filterCategory('DRINKS', this)">
                ‚òï –ù–∞–ø–∏—Ç–∫–∏
            </button>

            <button class="btn btn-outline-dark"
                    onclick="filterCategory('SOUPS', this)">
                üç≤ –°—É–ø—ã
            </button>

            <button class="btn btn-outline-dark"
                    onclick="filterCategory('BAKERY', this)">
                ü•ê –í—ã–ø–µ—á–∫–∞
            </button>

            <button class="btn btn-outline-dark"
                    onclick="filterCategory('HOT', this)">
                üçñ –ì–æ—Ä—è—á–µ–µ
            </button>

            <button class="btn btn-outline-dark"
                    onclick="filterCategory('SALADS', this)">
                ü•ó –°–∞–ª–∞—Ç—ã
            </button>

        </div>
    </div>

    <!-- ===== MENU ITEMS ===== -->
    <div class="row g-3" th:if="${menuItems != null}">
        <div class="col-md-4 menu-item"
             th:each="item : ${menuItems}"
             th:attr="data-category=${item.category}">

            <div class="card h-100 shadow-sm">

                <img th:if="${item.imageUrl != null}"
                     th:src="${item.imageUrl}"
                     class="card-img-top"
                     style="height:200px; object-fit:cover;">

                <div class="card-body d-flex flex-column">

                    <h5 th:text="${item.name}"></h5>
                    <p class="flex-grow-1" th:text="${item.description}"></p>

                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

                        <span class="fw-bold"
                              th:text="${item.price} + ' ‚ÇΩ'"></span>

                        <div class="d-flex gap-1">

                            <button class="btn btn-outline-secondary btn-sm"
                                    th:attr="onclick=|openCompositionModal(${item.id}, '${item.name}')|">
                                –°–æ—Å—Ç–∞–≤
                            </button>

                            <button class="btn btn-outline-info btn-sm"
                                    th:attr="onclick=|openCommentsModal(${item.id}, '${item.name}')|">
                                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                            </button>

                            <button class="btn btn-primary btn-sm"
                                    th:attr="onclick=|openCustomizeModal(${item.id}, '${item.name}')|">
                                –î–æ–±–∞–≤–∏—Ç—å
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ================= PROFILE MODAL ================= -->
<div class="modal fade" id="profileModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <div class="modal-header">
                <h5>
                    –ü—Ä–æ—Ñ–∏–ª—å:
                    <span th:text="${currentUser.username}"></span>
                </h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <h6>
                    –ë–∞–ª–∞–Ω—Å:
                    <span class="fw-bold"
                          data-balance
                          th:text="${currentUser.balance}"></span> ‚ÇΩ
                </h6>

                <form th:action="@{/balance/topup}"
                      method="post"
                      class="d-flex gap-2 mt-3 mb-4">
                    <input type="number"
                           name="amount"
                           step="0.01"
                           min="1"
                           class="form-control"
                           placeholder="–°—É–º–º–∞"
                           required>
                    <button class="btn btn-success">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                </form>

                <hr>

                <h5>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h5>
                <div id="ordersContainer"
                     style="max-height:300px; overflow-y:auto;"></div>

                <hr>

                <h5>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h5>
                <div class="table-responsive"
                     style="max-height:300px; overflow-y:auto;">
                    <table class="table table-sm w-100">
                        <thead>
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ===== COMPOSITION MODAL ===== -->
<div class="modal fade" id="compositionModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="compositionTitle"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul id="ingredientsList"></ul>
            </div>
        </div>
    </div>
</div>

<!-- ===== COMMENTS MODAL ===== -->
<div class="modal fade" id="commentsModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="commentsTitle"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                ‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥:
                <strong id="averageRating">0</strong>

                <div id="commentsContainer"
                     style="max-height:300px; overflow-y:auto;"
                     class="my-3"></div>

                <hr>

                <div class="mb-2">
                    <span class="star" onclick="selectRating(1)">‚òÖ</span>
                    <span class="star" onclick="selectRating(2)">‚òÖ</span>
                    <span class="star" onclick="selectRating(3)">‚òÖ</span>
                    <span class="star" onclick="selectRating(4)">‚òÖ</span>
                    <span class="star" onclick="selectRating(5)">‚òÖ</span>
                </div>

                <div class="d-flex gap-2">
                    <input id="newCommentText"
                           maxlength="200"
                           class="form-control"
                           placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)">
                    <button class="btn btn-primary"
                            onclick="submitComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>

                <small>–û—Å—Ç–∞–ª–æ—Å—å:
                    <span id="charCount">200</span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast-container">
    <div id="commentToast"
         class="toast align-items-center text-bg-success border-0">
        <div class="d-flex">
            <div class="toast-body">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω</div>
            <button class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">

    let currentMenuItemId = null;
    let currentRating = 0;
    let interval = null;
    let currentUsername = /*[[${currentUser.username}]]*/ "";

    /* ===== –§–ò–õ–¨–¢–† –ö–ê–¢–ï–ì–û–†–ò–ô ===== */
    function filterCategory(category, button) {

        document.querySelectorAll('.btn-group button')
            .forEach(btn => {
                btn.classList.remove('active','btn-dark');
                btn.classList.add('btn-outline-dark');
            });

        button.classList.add('active','btn-dark');
        button.classList.remove('btn-outline-dark');

        document.querySelectorAll('.menu-item')
            .forEach(item => {
                const itemCategory =
                    item.getAttribute('data-category');

                item.style.display =
                    (category === 'ALL' ||
                        itemCategory === category)
                        ? "block" : "none";
            });
    }

    /* ===== –°–û–°–¢–ê–í ===== */
    function openCompositionModal(id, name) {

        document.getElementById("compositionTitle").textContent = name;

        const list = document.getElementById("ingredientsList");
        list.innerHTML = "<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>";

        fetch("/api/menu/" + id + "/ingredients")
            .then(res => res.json())
            .then(data => {

                list.innerHTML = "";

                if (!data || data.length === 0) {
                    list.innerHTML = "<li>–°–æ—Å—Ç–∞–≤ –Ω–µ —É–∫–∞–∑–∞–Ω</li>";
                    return;
                }

                data.forEach(link => {

                    const li = document.createElement("li");

                    li.textContent =
                        link.ingredient.name +
                        " ‚Äî " +
                        link.quantity +
                        " " +
                        link.ingredient.unit;

                    list.appendChild(li);
                });

            })
            .catch(() => {
                list.innerHTML = "<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–∞–≤–∞</li>";
            });

        new bootstrap.Modal(
            document.getElementById("compositionModal")
        ).show();
    }


    /* ===== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò ===== */
    function openCommentsModal(id, name) {

        currentMenuItemId = id;

        document.getElementById("commentsTitle")
            .textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫: " + name;

        loadComments();

        interval = setInterval(loadComments, 5000);

        new bootstrap.Modal(
            document.getElementById("commentsModal")
        ).show();
    }

    document.getElementById("commentsModal")
        .addEventListener("hidden.bs.modal", () => {
            clearInterval(interval);
        });

    function loadComments() {

        fetch("/api/comments/" + currentMenuItemId)
            .then(res => res.json())
            .then(data => {

                const container =
                    document.getElementById("commentsContainer");

                container.innerHTML = "";

                let total = 0;

                if (data.length === 0) {
                    container.innerHTML =
                        "<div class='text-muted'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>";
                }

                data.forEach(c => {

                    total += c.rating || 0;

                    const card = document.createElement("div");
                    card.className = "card mb-2 fade-in";

                    card.innerHTML = `
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <strong>${c.username}</strong>
                                ${c.username === currentUsername
                        ? `<button class="btn btn-sm btn-danger"
                                       onclick="deleteComment(${c.id})">√ó</button>`
                        : ""}
                            </div>
                            <div>${"‚òÖ".repeat(c.rating || 0)}</div>
                            <div>${c.text}</div>
                            <div class="text-muted small">
                                ${c.createdAt.replace("T"," ").substring(0,16)}
                            </div>
                        </div>
                    `;

                    container.appendChild(card);
                });

                document.getElementById("averageRating")
                    .textContent =
                    data.length
                        ? (total / data.length).toFixed(1)
                        : 0;
            });
    }

    function submitComment() {

        const text =
            document.getElementById("newCommentText").value;

        if (!text.trim()) return;

        fetch("/api/comments/" + currentMenuItemId, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                text: text,
                rating: currentRating
            })
        }).then(() => {

            document.getElementById("newCommentText").value = "";
            currentRating = 0;
            updateStars();
            loadComments();

            const toast = new bootstrap.Toast(
                document.getElementById("commentToast")
            );
            toast.show();
        });
    }

    function deleteComment(id) {
        fetch("/api/comments/delete/" + id, {
            method: "DELETE"
        }).then(loadComments);
    }

    /* ===== –†–ï–ô–¢–ò–ù–ì ===== */
    function selectRating(r) {
        currentRating = r;
        updateStars();
    }

    function updateStars() {
        document.querySelectorAll(".star")
            .forEach((s, i) =>
                s.classList.toggle("selected", i < currentRating)
            );
    }

    /* ===== –õ–ò–ú–ò–¢ ===== */
    document.getElementById("newCommentText")
        .addEventListener("input", function() {
            document.getElementById("charCount")
                .textContent = 200 - this.value.length;
        });

    /* ===== –ü–†–û–§–ò–õ–¨ ===== */
    function loadProfileData() {

        fetch('/api/profile')
            .then(res => res.json())
            .then(data => {

                document.querySelectorAll('[data-balance]')
                    .forEach(el => el.textContent = data.balance);

                const orders =
                    document.getElementById("ordersContainer");

                orders.innerHTML = "";

                data.orders.forEach(order => {
                    orders.innerHTML += `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between">
                                    <strong>‚Ññ${order.id}</strong>
                                    <span class="badge bg-secondary">
                                        ${order.status}
                                    </span>
                                </div>
                                <div class="small mt-1">
                                    ${order.total} ‚ÇΩ
                                </div>
                                <div class="text-muted small">
                                    ${order.createdAt.replace("T"," ").substring(0,16)}
                                </div>
                            </div>
                        </div>
                    `;
                });

                const txBody =
                    document.getElementById("transactionsBody");

                txBody.innerHTML = "";

                data.transactions.forEach(tx => {
                    txBody.innerHTML += `
                        <tr>
                            <td>${tx.type}</td>
                            <td>${tx.amount}</td>
                            <td>${tx.createdAt.replace("T"," ").substring(0,16)}</td>
                        </tr>
                    `;
                });
            });
    }

    document.getElementById('profileModal')
        .addEventListener('shown.bs.modal', loadProfileData);

    let currentCustomizeId = null;

    function openCustomizeModal(id, name){

        currentCustomizeId = id;

        document.getElementById("customizeTitle")
            .textContent = "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å: " + name;

        fetch("/api/menu/" + id + "/ingredients")
            .then(res => res.json())
            .then(data => {

                let html = "";

                data.forEach(link => {

                    html += `
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               value="${link.ingredient.id}"
                               id="ing${link.ingredient.id}">
                        <label class="form-check-label">
                            –£–±—Ä–∞—Ç—å ${link.ingredient.name}
                        </label>
                    </div>
                `;
                });

                document.getElementById("customizeIngredients").innerHTML = html;
            });

        document.getElementById("confirmAddBtn")
            .onclick = submitCustomizedAdd;

        new bootstrap.Modal(
            document.getElementById("customizeModal")
        ).show();
    }

    function submitCustomizedAdd(){

        const removed = [];

        document
            .querySelectorAll("#customizeIngredients input:checked")
            .forEach(cb => removed.push(cb.value));

        fetch("/cart/add-custom", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                menuItemId: currentCustomizeId,
                removedIngredientIds: removed
            })
        }).then(() => {
            location.reload();
        });
    }

</script>

<!-- ===== CUSTOMIZE MODAL ===== -->
<div class="modal fade" id="customizeModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 id="customizeTitle"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div id="customizeIngredients"></div>

                <button class="btn btn-success w-100 mt-3"
                        id="confirmAddBtn">
                    –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                </button>

            </div>
        </div>
    </div>
</div>


</body>
</html>
